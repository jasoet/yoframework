<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Json.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">id.yoframework.core.json</a> &gt; <span class="el_source">Json.kt</span></div><h1>Json.kt</h1><pre class="source lang-java linenums">/*
 * Copyright (C)2018 - Deny Prasetyo &lt;jasoet87@gmail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package id.yoframework.core.json

import arrow.core.Try
import arrow.core.getOrElse
import id.yoframework.core.extension.logger.logger
import io.vertx.core.json.JsonArray
import io.vertx.core.json.JsonObject
import io.vertx.kotlin.core.json.get
import java.time.Instant
import kotlin.reflect.KClass
import kotlin.reflect.full.isSubclassOf

<span class="fc" id="L29">private val log = logger(&quot;Json Extension&quot;)</span>

/**
 * Convert [JsonObject] to [T] object, and throws [IllegalArgumentException] if failed.
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @see id.yoframework.core.module.CoreModule
 */
@Throws(IllegalArgumentException::class)
inline fun &lt;reified T : Any&gt; JsonObject.mapTo(): T {
    return this.mapTo(T::class.java)
}

/**
 * Convert [JsonObject] to [T] object, and return null if failed or receiver is null .
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @see id.yoframework.core.module.CoreModule
 */
fun &lt;T : Any&gt; JsonObject?.toValue(clazz: KClass&lt;T&gt;): T? {
<span class="fc" id="L49">    return try {</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">        this?.mapTo(clazz.java)</span>
<span class="fc" id="L51">    } catch (ie: IllegalArgumentException) {</span>
<span class="fc" id="L52">        log.warn(ie.message, ie)</span>
<span class="fc" id="L53">        null</span>
    }
}

/**
 * Reified version of [toValue]
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @see id.yoframework.core.json.toValue
 */
inline fun &lt;reified T : Any&gt; JsonObject?.toValue(): T? {
    return this.toValue(T::class)
}

<span class="fc" id="L67">private val supportedPrimitiveTypes = listOf(</span>
<span class="fc" id="L68">    String::class,</span>
    Int::class,
    Long::class,
    Double::class,
    Float::class,
    Boolean::class
)

<span class="fc" id="L76">private val primitiveMapping: (KClass&lt;*&gt;, JsonObject, String) -&gt; Any? = { clazz, json, key -&gt;</span>
<span class="fc" id="L77">    when {</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        clazz.isSubclassOf(String::class) -&gt; json.getString(key)</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        clazz.isSubclassOf(Int::class) -&gt; json.getInteger(key)</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        clazz.isSubclassOf(Long::class) -&gt; json.getLong(key)</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        clazz.isSubclassOf(Double::class) -&gt; json.getDouble(key)</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        clazz.isSubclassOf(Float::class) -&gt; json.getFloat(key)</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        clazz.isSubclassOf(Boolean::class) -&gt; json.getBoolean(key)</span>
<span class="nc" id="L84">        else -&gt; null</span>
    }
}

<span class="fc" id="L88">private val supportedTypes = listOf(</span>
<span class="fc" id="L89">    Instant::class,</span>
    JsonObject::class,
    ByteArray::class,
    JsonArray::class
)

<span class="fc" id="L95">private val mapping: (KClass&lt;*&gt;, JsonObject, String) -&gt; Any? = { clazz, json, key -&gt;</span>
<span class="nc" id="L96">    when {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        clazz.isSubclassOf(Instant::class) -&gt; json.getInstant(key)</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        clazz.isSubclassOf(JsonObject::class) -&gt; json.getJsonObject(key)</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        clazz.isSubclassOf(JsonArray::class) -&gt; json.getJsonArray(key)</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        clazz.isSubclassOf(ByteArray::class) -&gt; json.getBinary(key)</span>
<span class="nc" id="L101">        else -&gt; null</span>
    }
}

/**
 * Get direct parent from path [path]
 * return pair of [JsonObject] and [String] remaining path or null if path is invalid.
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @see id.yoframework.core.module.CoreModule
 */
private fun JsonObject.getDirectParent(path: String): Pair&lt;JsonObject, String&gt;? {
<span class="fc" id="L113">    val paths = path.split(&quot;.&quot;)</span>
<span class="fc" id="L114">    return when {</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        paths.size == 1 -&gt; this to path</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        paths.size &gt; 1 -&gt; {</span>
<span class="nc" id="L117">            val parents = paths.subList(0, paths.size - 1)</span>
<span class="nc" id="L118">            val jsonParent = try {</span>
<span class="nc" id="L119">                parents.fold(this as JsonObject?) { item, parent -&gt;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    item?.getJsonObject(parent)</span>
                }
<span class="nc" id="L122">            } catch (e: ClassCastException) {</span>
<span class="nc" id="L123">                log.warn(&quot;${e.message} occurred when get direct parent&quot;, e)</span>
<span class="nc" id="L124">                null</span>
            }

<span class="nc bnc" id="L127" title="All 2 branches missed.">            jsonParent?.let { it to paths.last() }</span>
        }
<span class="nc" id="L129">        else -&gt; null</span>
    }
}

/**
 * Get property [key] from [JsonObject] with [T] type, support nested path. return null if property not found.
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @throws [ClassCastException] if failed to convert.
 * @see id.yoframework.core.module.CoreModule
 */
@Suppress(&quot;UNCHECKED_CAST&quot;)
fun &lt;T : Any&gt; JsonObject?.getNested(clazz: KClass&lt;T&gt;, key: String): T? {
<span class="pc bpc" id="L142" title="2 of 4 branches missed.">    val (parent, lastPath) = this?.getDirectParent(key) ?: return null</span>
<span class="fc" id="L143">    return when {</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        supportedPrimitiveTypes.any { clazz.isSubclassOf(it) } -&gt; primitiveMapping(clazz, parent, lastPath) as T?</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        supportedTypes.any { clazz.isSubclassOf(it) } -&gt; mapping(clazz, parent, lastPath) as T?</span>
<span class="nc" id="L146">        else -&gt; parent.get&lt;T&gt;(lastPath)</span>
    }
}

/**
 * Get property [key] from [JsonObject] with [T] type, support nested path. return null if property not found.
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @throws [ClassCastException] if failed to convert.
 * @see id.yoframework.core.module.CoreModule
 */
inline fun &lt;reified T : Any&gt; JsonObject?.getNested(key: String): T? {
    return this.getNested(T::class, key)
}

/**
 * Get property [key] from [JsonObject] with [T] type, support nested path. return null if property not found.
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @throws [ClassCastException] if failed to convert.
 * @see id.yoframework.core.module.CoreModule
 */
inline operator fun &lt;reified T : Any&gt; JsonObject?.get(key: String): T? {
    return this.getNested(T::class, key)
}

/**
 * Get property [key] from [JsonObject] with [T] type, support nested path. return monad [Try]
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @throws [ClassCastException] if failed to convert.
 * @see id.yoframework.core.module.CoreModule
 */
<span class="nc" id="L179">inline fun &lt;reified T : Any&gt; JsonObject.getTry(</span>
<span class="nc" id="L180">    key: String, exceptionMessage: (String) -&gt; String = { &quot;$it is required!&quot; }</span>
): Try&lt;T&gt; {
<span class="nc" id="L182">    return Try {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        this.getNested(key) ?: throw IllegalArgumentException(exceptionMessage(key))</span>
    }
}

/**
 * Get property [key] from [JsonObject] with [T] type, support nested path. return exception if property not found.
 * Require [com.fasterxml.jackson.module.kotlin.KotlinModule] installed on Json.mapper.
 *
 * @throws [ClassCastException] if failed to convert.
 * @see id.yoframework.core.module.CoreModule
 */
<span class="nc" id="L194">inline fun &lt;reified T : Any&gt; JsonObject.getExcept(</span>
<span class="nc" id="L195">    key: String, exceptionMessage: (String) -&gt; String = { &quot;$it is required!&quot; }</span>
): T {
<span class="nc" id="L197">    return this.getTry&lt;T&gt;(key, exceptionMessage).getOrElse { throw it }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>